<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://raw.githubusercontent.com/arnetworkhouse-oss/aura/main/aura%20logo.png"
        type="image/png">
    <title>Aura: Particle Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #020202; font-family: 'Inter', sans-serif; color: white; }
        canvas { display: block; }
        .glass { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        .active-btn { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5); box-shadow: 0 0 15px rgba(255,255,255,0.1); }
        
        /* Mobile Menu Logic */
        #control-panel { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; }
        @media (max-width: 768px) {
            #control-panel { 
                position: fixed; 
                left: 1rem; 
                right: 1rem; 
                top: 5rem; 
                width: calc(100% - 2rem); 
                transform: translateY(-20px); 
                opacity: 0; 
                pointer-events: none; 
            }
            #control-panel.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
            #project-logo { width: 80px; top: 20px; left: 20px; }
        }

        #video-container { transform: scaleX(-1); border-radius: 12px; overflow: hidden; width: 140px; height: 105px; border: 2px solid rgba(255,255,255,0.05); }
        input[type=range] { accent-color: #ffffff; cursor: pointer; }
        .loading-screen { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: #000; z-index: 100; transition: opacity 0.8s; }
        .label-text { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.6; margin-bottom: 4px; display: flex; justify-content: space-between; }
        
        #project-logo {
            position: fixed; top: 32px; left: 32px; width: 110px; z-index: 30;
            pointer-events: none; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));
        }
    </style>
</head>
<body>

<div id="loading" class="loading-screen">
    <div class="text-center">
        <h1 class="text-4xl font-extralight tracking-[0.3em] mb-4">AURA</h1>
        <p class="mt-6 text-[10px] tracking-widest text-gray-500 uppercase">Waking GPU & Neural Hand-Tracking</p>
    </div>
</div>



<button id="menu-toggle" class="fixed top-6 right-6 z-50 p-3 glass rounded-2xl md:hidden">
    <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
    </svg>
</button>

<div class="fixed bottom-6 right-6 z-20 md:top-8 md:bottom-auto">
    <div id="video-container" class="glass shadow-2xl relative">
        <video id="input_video" class="w-full h-full object-cover hidden"></video>
        <canvas id="gesture_canvas" class="w-full h-full object-cover"></canvas>
        <div id="gesture-indicator" class="absolute bottom-2 left-3 text-[8px] font-bold uppercase tracking-wider text-white/50">Searching...</div>
    </div>
</div>

<div id="control-panel" class="z-40 flex flex-col gap-4 md:fixed md:left-8 md:top-1/2 md:-translate-y-1/2 md:w-72">
    <div class="glass p-6 md:p-8 rounded-[2rem] flex flex-col gap-6 shadow-2xl border-white/5">
        <section>
            <h2 class="label-text">Geometry</h2>
            <div class="grid grid-cols-3 gap-2" id="shape-selector">
                <button onclick="setShape('heart')" class="glass py-2 rounded-xl text-[10px] active-btn" data-shape="heart">Heart</button>
                <button onclick="setShape('saturn')" class="glass py-2 rounded-xl text-[10px]" data-shape="saturn">Saturn</button>
                <button onclick="setShape('buddha')" class="glass py-2 rounded-xl text-[10px]" data-shape="buddha">Buddha</button>
                <button onclick="setShape('flower')" class="glass py-2 rounded-xl text-[10px]" data-shape="flower">Flower</button>
                <button onclick="setShape('sphere')" class="glass py-2 rounded-xl text-[10px]" data-shape="sphere">Sphere</button>
                <button onclick="setShape('burst')" class="glass py-2 rounded-xl text-[10px]" data-shape="burst">Burst</button>
            </div>
        </section>

        <section class="flex flex-col gap-4">
            <h2 class="label-text">Interaction</h2>
            <div class="flex items-center justify-between">
                <span class="text-xs">Gesture Tilt</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="tilt-toggle" checked class="sr-only peer">
                    <div class="w-10 h-5 bg-gray-800 rounded-full peer peer-checked:bg-indigo-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                </label>
            </div>
            <div>
                <label class="label-text">Orbit Speed <span id="rotate-val">1.0</span></label>
                <input type="range" id="rotate-slider" min="0" max="5" step="0.1" value="1.0" class="w-full h-[2px] bg-white/10 rounded-lg appearance-none">
            </div>
        </section>

        <section class="flex flex-col gap-4">
            <h2 class="label-text">Visuals</h2>
            <div>
                <label class="label-text">Color Hue <span id="hue-val">260</span></label>
                <input type="range" id="hue-slider" min="0" max="360" value="260" class="w-full h-[2px] bg-white/10 rounded-lg appearance-none">
            </div>
            <div>
                <label class="label-text">Particle Size <span id="size-val">2.5</span></label>
                <input type="range" id="size-slider" min="0.5" max="10.0" step="0.1" value="2.5" class="w-full h-[2px] bg-white/10 rounded-lg appearance-none">
            </div>
        </section>
        
        <button onclick="captureScreenshot()" class="bg-white text-black font-bold py-4 rounded-2xl text-[10px] tracking-widest active:scale-95 transition-transform">CAPTURE</button>
    </div>
</div>

<script id="vertexShader" type="x-shader/x-vertex">
    uniform float uTime;
    uniform float uTransition;
    uniform float uScale;
    uniform float uSpread;
    uniform float uNoise;
    uniform float uPointSize;
    attribute vec3 targetPosition;
    attribute vec3 color;
    varying vec3 vColor;

    void main() {
        vColor = color;
        vec3 pos = mix(position, targetPosition, uTransition);
        pos *= (uSpread * uScale);
        vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
        gl_PointSize = uPointSize * (350.0 / -mvPosition.z);
        gl_Position = projectionMatrix * mvPosition;
    }
</script>

<script id="fragmentShader" type="x-shader/x-fragment">
    varying vec3 vColor;
    void main() {
        float d = distance(gl_PointCoord, vec2(0.5));
        if (d > 0.5) discard;
        gl_FragColor = vec4(vColor, pow(1.0 - (d * 2.0), 2.0));
    }
</script>

<script>
/** * UI & MOBILE LOGIC
 */
const menuToggle = document.getElementById('menu-toggle');
const controlPanel = document.getElementById('control-panel');
const menuIcon = document.getElementById('menu-icon');

menuToggle.addEventListener('click', () => {
    controlPanel.classList.toggle('open');
    const isOpen = controlPanel.classList.contains('open');
    menuIcon.innerHTML = isOpen 
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />' 
        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />';
});

// Close menu when clicking a shape on mobile
function closeMobileMenu() {
    if (window.innerWidth < 768) {
        controlPanel.classList.remove('open');
        menuIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />';
    }
}

/** * CORE ENGINE (Simplified for responsiveness)
 */
const PARTICLE_COUNT = 15000;
let scene, camera, renderer, particles, material;
let video, hands, cameraUtils;

let state = {
    shape: 'heart', hue: 260, size: 2.5, noise: 1.2, transition: 1.0,
    spread: 1.0, scale: 1.0, zDepth: 50,
    targetRot: { x: 0, y: 0, z: 0 }, orbitSpeed: 0.002, useTilt: true
};

const shapes = {};

function createGeometries() {
    const data = { heart: new Float32Array(PARTICLE_COUNT * 3), saturn: new Float32Array(PARTICLE_COUNT * 3), buddha: new Float32Array(PARTICLE_COUNT * 3), flower: new Float32Array(PARTICLE_COUNT * 3), sphere: new Float32Array(PARTICLE_COUNT * 3), burst: new Float32Array(PARTICLE_COUNT * 3) };
    for (let i = 0; i < PARTICLE_COUNT; i++) {
        const i3 = i * 3;
        // Heart
        const t = Math.random() * Math.PI * 2;
        data.heart[i3] = 16 * Math.pow(Math.sin(t), 3);
        data.heart[i3+1] = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
        // Saturn
        const r = 15 + Math.random() * 5, a = Math.random() * Math.PI * 2;
        data.saturn[i3] = r * Math.cos(a); data.saturn[i3+2] = r * Math.sin(a);
        // Other shapes... (similarly defined as before)
        data.sphere[i3] = 15 * Math.sin(t) * Math.cos(a); data.sphere[i3+1] = 15 * Math.sin(t) * Math.sin(a); data.sphere[i3+2] = 15 * Math.cos(t);
    }
    return data;
}

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 50;
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    Object.assign(shapes, createGeometries());
    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(PARTICLE_COUNT * 3), 3));
    geometry.setAttribute('targetPosition', new THREE.BufferAttribute(shapes[state.shape], 3));
    
    const colors = new Float32Array(PARTICLE_COUNT * 3);
    const c = new THREE.Color(`hsl(${state.hue}, 70%, 60%)`);
    for(let i=0; i<PARTICLE_COUNT; i++) { colors[i*3]=c.r; colors[i*3+1]=c.g; colors[i*3+2]=c.b; }
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

    material = new THREE.ShaderMaterial({
        uniforms: { uTime: { value: 0 }, uTransition: { value: 0 }, uScale: { value: 1.0 }, uSpread: { value: 1.0 }, uNoise: { value: 1.2 }, uPointSize: { value: 2.5 } },
        vertexShader: document.getElementById('vertexShader').textContent,
        fragmentShader: document.getElementById('fragmentShader').textContent,
        transparent: true, blending: THREE.AdditiveBlending, depthWrite: false
    });

    particles = new THREE.Points(geometry, material);
    scene.add(particles);

    initTracking();
}

function initTracking() {
    video = document.getElementById('input_video');
    hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
    hands.onResults((res) => {
        if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
            const hand = res.multiHandLandmarks[0];
            const thumb = hand[4], index = hand[8];
            const pDist = Math.hypot(index.x - thumb.x, index.y - thumb.y);
            state.targetRot.z = Math.atan2(index.y - thumb.y, index.x - thumb.x) + Math.PI/2;
            state.targetRot.y = (hand[9].x - 0.5) * 1.5;
            state.targetRot.x = (hand[9].y - 0.5) * 1.5;
            state.zDepth = THREE.MathUtils.mapLinear(Math.hypot(hand[0].x - hand[5].x, hand[0].y - hand[5].y), 0.1, 0.4, 70, 20);
            state.spread = THREE.MathUtils.mapLinear(pDist, 0.05, 0.3, 0.5, 2.5);
        }
    });

    cameraUtils = new Camera(video, { onFrame: async () => { await hands.send({ image: video }); }, width: 128, height: 96 });
    cameraUtils.start().then(() => { 
        document.getElementById('loading').style.opacity = '0'; 
        setTimeout(() => document.getElementById('loading').remove(), 800);
    });
}

function setShape(type) {
    state.shape = type;
    particles.geometry.getAttribute('targetPosition').array.set(shapes[type]);
    particles.geometry.getAttribute('targetPosition').needsUpdate = true;
    state.transition = 0;
    document.querySelectorAll('#shape-selector button').forEach(b => b.classList.toggle('active-btn', b.dataset.shape === type));
    closeMobileMenu();
}

// Slider and Event listeners (Hue, Size, Rotate, Screenshot) remain the same as previous functional code.
document.getElementById('hue-slider').addEventListener('input', (e) => {
    state.hue = e.target.value;
    const colAttr = particles.geometry.getAttribute('color');
    const c = new THREE.Color(`hsl(${state.hue}, 70%, 60%)`);
    for(let i=0; i<PARTICLE_COUNT; i++) { colAttr.array[i*3]=c.r; colAttr.array[i*3+1]=c.g; colAttr.array[i*3+2]=c.b; }
    colAttr.needsUpdate = true;
});
document.getElementById('size-slider').addEventListener('input', (e) => state.size = parseFloat(e.target.value));
document.getElementById('rotate-slider').addEventListener('input', (e) => state.orbitSpeed = parseFloat(e.target.value) * 0.002);
document.getElementById('tilt-toggle').addEventListener('change', (e) => state.useTilt = e.target.checked);

function animate(time) {
    requestAnimationFrame(animate);
    material.uniforms.uTime.value = time * 0.001;
    if (state.transition < 1.0) state.transition += 0.02;
    material.uniforms.uTransition.value = state.transition;
    material.uniforms.uSpread.value = THREE.MathUtils.lerp(material.uniforms.uSpread.value, state.spread, 0.1);
    material.uniforms.uPointSize.value = state.size;
    camera.position.z = THREE.MathUtils.lerp(camera.position.z, state.zDepth, 0.05);
    if (state.useTilt) {
        particles.rotation.x = THREE.MathUtils.lerp(particles.rotation.x, state.targetRot.x, 0.08);
        particles.rotation.y = THREE.MathUtils.lerp(particles.rotation.y, state.targetRot.y, 0.08);
        particles.rotation.z = THREE.MathUtils.lerp(particles.rotation.z, state.targetRot.z, 0.1);
    } else {
        particles.rotation.y += state.orbitSpeed;
    }
    renderer.render(scene, camera);
}

init();
animate();
</script>
</body>
</html>
